(function($){$.jqplot.PieRenderer=function(){$.jqplot.LineRenderer.call(this)};$.jqplot.PieRenderer.prototype=new $.jqplot.LineRenderer;$.jqplot.PieRenderer.prototype.constructor=$.jqplot.PieRenderer;$.jqplot.PieRenderer.prototype.init=function(options,plot){this.diameter=null;this.padding=20;this.sliceMargin=0;this.fill=true;this.shadowOffset=2;this.shadowAlpha=.07;this.shadowDepth=5;this.highlightMouseOver=true;this.highlightMouseDown=false;this.highlightColors=[];this.dataLabels="percent";this.showDataLabels=false;this.dataLabelFormatString=null;this.dataLabelThreshold=3;this.dataLabelPositionFactor=.52;this.dataLabelNudge=2;this.dataLabelCenterOn=true;this.startAngle=0;this.tickRenderer=$.jqplot.PieTickRenderer;this.showSlice=[];this._drawData=true;this._type="pie";if(options.highlightMouseDown&&options.highlightMouseOver==null){options.highlightMouseOver=false}$.extend(true,this,options);if(this.sliceMargin<0){this.sliceMargin=0}this._diameter=null;this._radius=null;this._sliceAngles=[];this._highlightedPoint=null;if(this.highlightColors.length==0){for(var i=0;i<this.seriesColors.length;i++){var rgba=$.jqplot.getColorComponents(this.seriesColors[i]);var newrgb=[rgba[0],rgba[1],rgba[2]];var sum=newrgb[0]+newrgb[1]+newrgb[2];for(var j=0;j<3;j++){newrgb[j]=sum>570?newrgb[j]*.8:newrgb[j]+.3*(255-newrgb[j]);newrgb[j]=parseInt(newrgb[j],10)}this.highlightColors.push("rgb("+newrgb[0]+","+newrgb[1]+","+newrgb[2]+")")}}this.highlightColorGenerator=new $.jqplot.ColorGenerator(this.highlightColors);plot.postParseOptionsHooks.addOnce(postParseOptions);plot.postInitHooks.addOnce(postInit);plot.eventListenerHooks.addOnce("jqplotMouseMove",handleMove);plot.eventListenerHooks.addOnce("jqplotMouseDown",handleMouseDown);plot.eventListenerHooks.addOnce("jqplotMouseUp",handleMouseUp);plot.eventListenerHooks.addOnce("jqplotClick",handleClick);plot.eventListenerHooks.addOnce("jqplotRightClick",handleRightClick);plot.postDrawHooks.addOnce(postPlotDraw)};$.jqplot.PieRenderer.prototype.setGridData=function(plot){var stack=[];var td=[];var sa=this.startAngle/180*Math.PI;var tot=0;this._drawData=false;for(var i=0;i<this.data.length;i++){if(this.data[i][1]!=0){this._drawData=true;if(this.showSlice[i]===undefined){this.showSlice[i]=true}}stack.push(this.data[i][1]);td.push([this.data[i][0]]);if(i>0){stack[i]+=stack[i-1]}tot+=this.data[i][1]}var fact=Math.PI*2/stack[stack.length-1];for(var i=0;i<stack.length;i++){td[i][1]=stack[i]*fact;td[i][2]=this.data[i][1]/tot}this.gridData=td};$.jqplot.PieRenderer.prototype.makeGridData=function(data,plot){var stack=[];var td=[];var tot=0;var sa=this.startAngle/180*Math.PI;this._drawData=false;for(var i=0;i<data.length;i++){if(this.data[i][1]!=0){this._drawData=true}stack.push(data[i][1]);td.push([data[i][0]]);if(i>0){stack[i]+=stack[i-1]}tot+=data[i][1]}var fact=Math.PI*2/stack[stack.length-1];for(var i=0;i<stack.length;i++){td[i][1]=stack[i]*fact;td[i][2]=data[i][1]/tot}return td};function calcRadiusAdjustment(ang){return Math.sin((ang-(ang-Math.PI)/8/Math.PI)/2)}function calcRPrime(ang1,ang2,sliceMargin,fill,lineWidth){var rprime=0;var ang=ang2-ang1;var absang=Math.abs(ang);var sm=sliceMargin;if(fill==false){sm+=lineWidth}if(sm>0&&absang>.01&&absang<6.282){rprime=parseFloat(sm)/2/calcRadiusAdjustment(ang)}return rprime}$.jqplot.PieRenderer.prototype.drawSlice=function(ctx,ang1,ang2,color,isShadow){if(this._drawData){var r=this._radius;var fill=this.fill;var lineWidth=this.lineWidth;var sm=this.sliceMargin;if(this.fill==false){sm+=this.lineWidth}ctx.save();ctx.translate(this._center[0],this._center[1]);var rprime=calcRPrime(ang1,ang2,this.sliceMargin,this.fill,this.lineWidth);var transx=rprime*Math.cos((ang1+ang2)/2);var transy=rprime*Math.sin((ang1+ang2)/2);if(ang2-ang1<=Math.PI){r-=rprime}else{r+=rprime}ctx.translate(transx,transy);if(isShadow){for(var i=0,l=this.shadowDepth;i<l;i++){ctx.save();ctx.translate(this.shadowOffset*Math.cos(this.shadowAngle/180*Math.PI),this.shadowOffset*Math.sin(this.shadowAngle/180*Math.PI));doDraw(r)}for(var i=0,l=this.shadowDepth;i<l;i++){ctx.restore()}}else{doDraw(r)}ctx.restore()}function doDraw(rad){if(ang2>6.282+this.startAngle){ang2=6.282+this.startAngle;if(ang1>ang2){ang1=6.281+this.startAngle}}if(ang1>=ang2){return}ctx.beginPath();ctx.fillStyle=color;ctx.strokeStyle=color;ctx.lineWidth=lineWidth;ctx.arc(0,0,rad,ang1,ang2,false);ctx.lineTo(0,0);ctx.closePath();if(fill){ctx.fill()}else{ctx.stroke()}}};$.jqplot.PieRenderer.prototype.draw=function(ctx,gd,options,plot){var i;var opts=options!=undefined?options:{};var offx=0;var offy=0;var trans=1;var colorGenerator=new $.jqplot.ColorGenerator(this.seriesColors);var sliceColor;if(options.legendInfo&&options.legendInfo.placement=="insideGrid"){var li=options.legendInfo;switch(li.location){case"nw":offx=li.width+li.xoffset;break;case"w":offx=li.width+li.xoffset;break;case"sw":offx=li.width+li.xoffset;break;case"ne":offx=li.width+li.xoffset;trans=-1;break;case"e":offx=li.width+li.xoffset;trans=-1;break;case"se":offx=li.width+li.xoffset;trans=-1;break;case"n":offy=li.height+li.yoffset;break;case"s":offy=li.height+li.yoffset;trans=-1;break;default:break}}var shadow=opts.shadow!=undefined?opts.shadow:this.shadow;var fill=opts.fill!=undefined?opts.fill:this.fill;var cw=parseInt(ctx.canvas.style.width);var ch=parseInt(ctx.canvas.style.height);var w=cw-offx-2*this.padding;var h=ch-offy-2*this.padding;var mindim=Math.min(w,h);var d=mindim;this._sliceAngles=[];var sm=this.sliceMargin;if(this.fill==false){sm+=this.lineWidth}var rprime;var maxrprime=0;var ang,ang1,ang2,shadowColor;var sa=this.startAngle/180*Math.PI;for(var i=0,l=gd.length;i<l;i++){ang1=i==0?sa:gd[i-1][1]+sa;ang2=gd[i][1]+sa;this._sliceAngles.push([ang1,ang2]);rprime=calcRPrime(ang1,ang2,this.sliceMargin,this.fill,this.lineWidth);if(Math.abs(ang2-ang1)>Math.PI){maxrprime=Math.max(rprime,maxrprime)}}if(this.diameter!=null&&this.diameter>0){this._diameter=this.diameter-2*maxrprime}else{this._diameter=d-2*maxrprime}if(this._diameter<6){$.jqplot.log("Diameter of pie too small, not rendering.");return}var r=this._radius=this._diameter/2;this._center=[(cw-trans*offx)/2+trans*offx+maxrprime*Math.cos(sa),(ch-trans*offy)/2+trans*offy+maxrprime*Math.sin(sa)];if(this.shadow){for(var i=0,l=gd.length;i<l;i++){shadowColor="rgba(0,0,0,"+this.shadowAlpha+")";this.renderer.drawSlice.call(this,ctx,this._sliceAngles[i][0],this._sliceAngles[i][1],shadowColor,true)}}for(var i=0;i<gd.length;i++){sliceColor=colorGenerator.next();if(this.showSlice[i]){this.renderer.drawSlice.call(this,ctx,this._sliceAngles[i][0],this._sliceAngles[i][1],sliceColor,false);if(this.showDataLabels&&gd[i][2]*100>=this.dataLabelThreshold){var fstr,avgang=(this._sliceAngles[i][0]+this._sliceAngles[i][1])/2,label;if(this.dataLabels=="label"){fstr=this.dataLabelFormatString||"%s";label=$.jqplot.sprintf(fstr,gd[i][0])}else if(this.dataLabels=="value"){fstr=this.dataLabelFormatString||"%d";label=$.jqplot.sprintf(fstr,this.data[i][1])}else if(this.dataLabels=="percent"){fstr=this.dataLabelFormatString||"%d%%";label=$.jqplot.sprintf(fstr,gd[i][2]*100)}else if(this.dataLabels.constructor==Array){fstr=this.dataLabelFormatString||"%s";label=$.jqplot.sprintf(fstr,this.dataLabels[i])}var fact=this._radius*this.dataLabelPositionFactor+this.sliceMargin+this.dataLabelNudge;var x=this._center[0]+Math.cos(avgang)*fact+this.canvas._offsets.left;var y=this._center[1]+Math.sin(avgang)*fact+this.canvas._offsets.top;var labelelem=$('<div class="jqplot-pie-series jqplot-data-label" style="position:absolute;">'+label+"</div>").insertBefore(plot.eventCanvas._elem);if(this.dataLabelCenterOn){x-=labelelem.width()/2;y-=labelelem.height()/2}else{x-=labelelem.width()*Math.sin(avgang/2);y-=labelelem.height()/2}x=Math.round(x);y=Math.round(y);labelelem.css({left:x,top:y})}}}};$.jqplot.PieAxisRenderer=function(){$.jqplot.LinearAxisRenderer.call(this)};$.jqplot.PieAxisRenderer.prototype=new $.jqplot.LinearAxisRenderer;$.jqplot.PieAxisRenderer.prototype.constructor=$.jqplot.PieAxisRenderer;$.jqplot.PieAxisRenderer.prototype.init=function(options){this.tickRenderer=$.jqplot.PieTickRenderer;$.extend(true,this,options);this._dataBounds={min:0,max:100};this.min=0;this.max=100;this.showTicks=false;this.ticks=[];this.showMark=false;this.show=false};$.jqplot.PieLegendRenderer=function(){$.jqplot.TableLegendRenderer.call(this)};$.jqplot.PieLegendRenderer.prototype=new $.jqplot.TableLegendRenderer;$.jqplot.PieLegendRenderer.prototype.constructor=$.jqplot.PieLegendRenderer;$.jqplot.PieLegendRenderer.prototype.init=function(options){this.numberRows=null;this.numberColumns=null;this.width=null;$.extend(true,this,options)};$.jqplot.PieLegendRenderer.prototype.draw=function(){var legend=this;if(this.show){var series=this._series;this._elem=$(document.createElement("table"));this._elem.addClass("jqplot-table-legend");var ss={position:"absolute"};if(this.background){ss["background"]=this.background}if(this.border){ss["border"]=this.border}if(this.fontSize){ss["fontSize"]=this.fontSize}if(this.fontFamily){ss["fontFamily"]=this.fontFamily}if(this.textColor){ss["textColor"]=this.textColor}if(this.marginTop!=null){ss["marginTop"]=this.marginTop}if(this.marginBottom!=null){ss["marginBottom"]=this.marginBottom}if(this.marginLeft!=null){ss["marginLeft"]=this.marginLeft}if(this.marginRight!=null){ss["marginRight"]=this.marginRight}this._elem.css(ss);var pad=false,reverse=false,nr,nc;var s=series[0];var colorGenerator=new $.jqplot.ColorGenerator(s.seriesColors);if(s.show){var pd=s.data;if(this.numberRows){nr=this.numberRows;if(!this.numberColumns){nc=Math.ceil(pd.length/nr)}else{nc=this.numberColumns}}else if(this.numberColumns){nc=this.numberColumns;nr=Math.ceil(pd.length/this.numberColumns)}else{nr=pd.length;nc=1}var i,j;var tr,td1,td2;var lt,tt,rs,color;var idx=0;var div0,div1;for(i=0;i<nr;i++){tr=$(document.createElement("tr"));tr.addClass("jqplot-table-legend");if(reverse){tr.prependTo(this._elem)}else{tr.appendTo(this._elem)}for(j=0;j<nc;j++){if(idx<pd.length){tt="";if(this.labels[idx]){lt=this.labels[idx]}else{if(typeof pd[idx][0]==="object"){lt=pd[idx][0][0].toString();tt=pd[idx][0][1].toString()}else{lt=pd[idx][0].toString()}}color=colorGenerator.next();if(!reverse){if(i>0){pad=true}else{pad=false}}else{if(i==nr-1){pad=false}else{pad=true}}rs=pad?this.rowSpacing:"0";td1=$(document.createElement("td"));td1.addClass("jqplot-table-legend jqplot-table-legend-swatch");td1.css({textAlign:"center",paddingTop:rs});div0=$(document.createElement("div"));div0.addClass("jqplot-table-legend-swatch-outline");if(tt!==""){div0.attr("title",tt)}div1=$(document.createElement("div"));div1.addClass("jqplot-table-legend-swatch");div1.css({backgroundColor:color,borderColor:color});td1.append(div0.append(div1));td2=$(document.createElement("td"));td2.addClass("jqplot-table-legend jqplot-table-legend-label");td2.css("paddingTop",rs);if(this.escapeHtml){td2.text(lt)}else{td2.html('<a title="'+tt+'">'+lt+"</a>")}if(reverse){td2.prependTo(tr);td1.prependTo(tr)}else{td1.appendTo(tr);td2.appendTo(tr)}pad=true}idx++}}}}return this._elem};$.jqplot.PieRenderer.prototype.handleMove=function(ev,gridpos,datapos,neighbor,plot){if(neighbor){var ins=[neighbor.seriesIndex,neighbor.pointIndex,neighbor.data];plot.target.trigger("jqplotDataMouseOver",ins);if(plot.series[ins[0]].highlightMouseOver&&!(ins[0]==plot.plugins.pieRenderer.highlightedSeriesIndex&&ins[1]==plot.series[ins[0]]._highlightedPoint)){plot.target.trigger("jqplotDataHighlight",ins);highlight(plot,ins[0],ins[1])}}else if(neighbor==null){unhighlight(plot)}};function preInit(target,data,options){options=options||{};options.axesDefaults=options.axesDefaults||{};options.legend=options.legend||{};options.seriesDefaults=options.seriesDefaults||{};var setopts=false;if(options.seriesDefaults.renderer==$.jqplot.PieRenderer){setopts=true}else if(options.series){for(var i=0;i<options.series.length;i++){if(options.series[i].renderer==$.jqplot.PieRenderer){setopts=true}}}if(setopts){options.axesDefaults.renderer=$.jqplot.PieAxisRenderer;options.legend.renderer=options.legend.renderer||$.jqplot.PieLegendRenderer;options.legend.preDraw=true;options.seriesDefaults.pointLabels={show:false}}}function postInit(target,data,options){for(var i=0;i<this.series.length;i++){if(this.series[i].renderer.constructor==$.jqplot.PieRenderer){if(this.series[i].highlightMouseOver){this.series[i].highlightMouseDown=false}}}}function postParseOptions(options){for(var i=0;i<this.series.length;i++){this.series[i].seriesColors=this.seriesColors;this.series[i].colorGenerator=$.jqplot.colorGenerator}}function highlight(plot,sidx,pidx){if(plot.series[sidx].showSlice[pidx]){var s=plot.series[sidx];var canvas=plot.plugins.pieRenderer.highlightCanvas;canvas._ctx.clearRect(0,0,canvas._ctx.canvas.width,canvas._ctx.canvas.height);s._highlightedPoint=pidx;plot.plugins.pieRenderer.highlightedSeriesIndex=sidx;s.renderer.drawSlice.call(s,canvas._ctx,s._sliceAngles[pidx][0],s._sliceAngles[pidx][1],s.highlightColorGenerator.get(pidx),false)}}function unhighlight(plot){var canvas=plot.plugins.pieRenderer.highlightCanvas;canvas._ctx.clearRect(0,0,canvas._ctx.canvas.width,canvas._ctx.canvas.height);for(var i=0;i<plot.series.length;i++){plot.series[i]._highlightedPoint=null}plot.plugins.pieRenderer.highlightedSeriesIndex=null;plot.target.trigger("jqplotDataUnhighlight")}function handleMove(ev,gridpos,datapos,neighbor,plot){if(neighbor){var ins=[neighbor.seriesIndex,neighbor.pointIndex,neighbor.data];var evt1=jQuery.Event("jqplotDataMouseOver");evt1.pageX=ev.pageX;evt1.pageY=ev.pageY;plot.target.trigger(evt1,ins);if(plot.series[ins[0]].highlightMouseOver&&!(ins[0]==plot.plugins.pieRenderer.highlightedSeriesIndex&&ins[1]==plot.series[ins[0]]._highlightedPoint)){var evt=jQuery.Event("jqplotDataHighlight");evt.which=ev.which;evt.pageX=ev.pageX;evt.pageY=ev.pageY;plot.target.trigger(evt,ins);highlight(plot,ins[0],ins[1])}}else if(neighbor==null){unhighlight(plot)}}function handleMouseDown(ev,gridpos,datapos,neighbor,plot){if(neighbor){var ins=[neighbor.seriesIndex,neighbor.pointIndex,neighbor.data];if(plot.series[ins[0]].highlightMouseDown&&!(ins[0]==plot.plugins.pieRenderer.highlightedSeriesIndex&&ins[1]==plot.series[ins[0]]._highlightedPoint)){var evt=jQuery.Event("jqplotDataHighlight");evt.which=ev.which;evt.pageX=ev.pageX;evt.pageY=ev.pageY;plot.target.trigger(evt,ins);highlight(plot,ins[0],ins[1])}}else if(neighbor==null){unhighlight(plot)}}function handleMouseUp(ev,gridpos,datapos,neighbor,plot){var idx=plot.plugins.pieRenderer.highlightedSeriesIndex;if(idx!=null&&plot.series[idx].highlightMouseDown){unhighlight(plot)}}function handleClick(ev,gridpos,datapos,neighbor,plot){if(neighbor){var ins=[neighbor.seriesIndex,neighbor.pointIndex,neighbor.data];var evt=jQuery.Event("jqplotDataClick");evt.which=ev.which;evt.pageX=ev.pageX;evt.pageY=ev.pageY;plot.target.trigger(evt,ins)}}function handleRightClick(ev,gridpos,datapos,neighbor,plot){if(neighbor){var ins=[neighbor.seriesIndex,neighbor.pointIndex,neighbor.data];var idx=plot.plugins.pieRenderer.highlightedSeriesIndex;if(idx!=null&&plot.series[idx].highlightMouseDown){unhighlight(plot)}var evt=jQuery.Event("jqplotDataRightClick");evt.which=ev.which;evt.pageX=ev.pageX;evt.pageY=ev.pageY;plot.target.trigger(evt,ins)}}function postPlotDraw(){if(this.plugins.pieRenderer&&this.plugins.pieRenderer.highlightCanvas){this.plugins.pieRenderer.highlightCanvas.resetCanvas();this.plugins.pieRenderer.highlightCanvas=null}this.plugins.pieRenderer={highlightedSeriesIndex:null};this.plugins.pieRenderer.highlightCanvas=new $.jqplot.GenericCanvas;var labels=$(this.targetId+" .jqplot-data-label");if(labels.length){$(labels[0]).before(this.plugins.pieRenderer.highlightCanvas.createElement(this._gridPadding,"jqplot-pieRenderer-highlight-canvas",this._plotDimensions,this))}else{this.eventCanvas._elem.before(this.plugins.pieRenderer.highlightCanvas.createElement(this._gridPadding,"jqplot-pieRenderer-highlight-canvas",this._plotDimensions,this))}var hctx=this.plugins.pieRenderer.highlightCanvas.setContext();this.eventCanvas._elem.bind("mouseleave",{plot:this},function(ev){unhighlight(ev.data.plot)})}$.jqplot.preInitHooks.push(preInit);$.jqplot.PieTickRenderer=function(){$.jqplot.AxisTickRenderer.call(this)};$.jqplot.PieTickRenderer.prototype=new $.jqplot.AxisTickRenderer;$.jqplot.PieTickRenderer.prototype.constructor=$.jqplot.PieTickRenderer})(jQuery);